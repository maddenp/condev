#!/bin/bash

set -eu

condev_rc() {
  local meta name oldenv
  test -e ~/.bashrc && source ~/.bashrc
  if [[ -z "${RECIPE_DIR:-}" ]]; then
    export RECIPE_DIR=$(realpath ./recipe)
    echo "=> RECIPE_DIR not set, trying $RECIPE_DIR"
  else
    echo "=> Recipe directory is $RECIPE_DIR"
  fi
  test ! -e $RECIPE_DIR/meta.yaml && echo "=> No meta.yaml found in $RECIPE_DIR" && false
  source $(realpath $(dirname $CONDA)/../etc/profile.d/conda.sh)
  conda activate
  echo "=> Preparing development environment"
  make meta
  meta=$(realpath $PWD/recipe/meta.json)
  name=${DEV_ENV_PREFIX:-DEV}-$(jq -r .name $meta)
  if conda env list | grep -q "^$name "; then
    oldenv=true
    echo "=> Found existing environment $name"
  else
    oldenv=false
    echo "=> Creating environment $name"
    conda create -y -n $name --file <( jq -r .packages[] $meta ) --repodata-fn repodata.json
  fi
  echo "=> Activating environment $name"
  set +u && conda activate $name && set -u
  if [[ $oldenv = false ]]; then
    echo "=> Doing editable install with setuptools"
    if ! (cd $(jq -r .source $meta) && pip install --editable .); then
      set +u && conda deactivate && conda env remove -n $name && set -u
      false
    fi
  fi
  echo "=> Development environment active (type 'exit' when finished)"
  unset -f condev_rc condev_shell
  set +eu
}

condev_shell() {
  test -z "${CONDA_DEFAULT_ENV:-}" && eval "$(conda shell.bash hook)" && conda activate
  local vars=( CONDA=$CONDA_EXE )
  env ${vars[@]} /bin/bash --rcfile <( sed -e "s/^condev_shell$/condev_rc/" $0 )
}

condev_shell
