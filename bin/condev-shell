#!/bin/bash

set -eu

condev_rc() {
  local meta name prefix srcdir
  test -e ~/.bashrc && source ~/.bashrc
  if [[ -z "${RECIPE_DIR:-}" ]]; then
    export RECIPE_DIR=$(realpath ./recipe)
    echo "=> RECIPE_DIR not set, trying $RECIPE_DIR"
  else
    echo "=> Recipe directory is $RECIPE_DIR"
  fi
  test ! -e $RECIPE_DIR/meta.yaml && echo "=> No meta.yaml found in $RECIPE_DIR" && false
  source $(realpath $(dirname $CONDA)/../etc/profile.d/conda.sh)
  conda activate
  echo "=> Preparing development environment"
  make meta
  meta=$(realpath $PWD/recipe/meta.json)
  name=${DEV_ENV_PREFIX:-DEV}-$(jq -r .name $meta)
  if conda env list | grep -q "^$name "; then
    echo "=> Activating existing environment $name"
    set +u && conda activate $name && set -u
  else
    echo "=> Creating environment $name"
    conda create -y -n $name --file <( jq -r .packages[] $meta ) --repodata-fn repodata.json
    srcdir=$(jq -r .source $meta)
    if [[ -e $srcdir/setup.py ]]; then
      echo "=> Doing editable install with setuptools"
      if ! (cd $srcdir && pip install --editable .); then
        set +u && conda deactivate && conda env remove -n $name
        false
      fi
    fi
    echo "=> Creating [de]activation scripts"
    prefix=$(set +u && conda activate $name && echo $CONDA_PREFIX)
    mkdir -pv $prefix/etc/conda/{activate,deactivate}.d
    cat <<'EOF' >$prefix/etc/conda/activate.d/devshell.sh
test -n "${PREFIX+x}" && export CONDEV_OLD_PREFIX=$PREFIX
export PREFIX=$CONDA_PREFIX
EOF
    cat <<'EOF' >$prefix/etc/conda/deactivate.d/devshell.sh
test -n "${CONDEV_OLD_PREFIX+x}" && export PREFIX=$CONDEV_OLD_PREFIX || unset PREFIX
unset CONDEV_OLD_PREFIX
EOF
    echo "=> Activating new environment $name"
    set +u && conda activate $name && set -u
  fi
  echo "=> Development environment active (type 'exit' when finished)"
  unset -f condev_rc condev_shell
  set +eu
}

condev_shell() {
  test -z "${CONDA_DEFAULT_ENV:-}" && eval "$(conda shell.bash hook)" && conda activate
  local vars=( CONDA=$CONDA_EXE )
  env ${vars[@]} /bin/bash --rcfile <( sed -e "s/^condev_shell$/condev_rc/" $0 )
}

condev_shell
